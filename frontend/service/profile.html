<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="profile.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark ctm-navbar p-1">
        <span class="navbar-brand ms-2" id="pong">PONG</span>
        <div class="d-flex ms-auto align-items-center">
            <a class="nav-link ctm-link" href="index.html">Home</a>
        </div>
    </nav>
    <div id="profile-section" class="container mt-5 blinking-neon-frame">
        <div id="profile-card" class="ctm-card position-relative">
            <h2 class="text-center ctm-text-title">My profile</h2>
            <div class="d-flex justify-content-center">
                <div class="d-flex flex-column align-items-center">
                    <div class="profile-picture-container mb-2">
                        <img id="profile-picture" src="https://avatars.githubusercontent.com/u/131959167?v=4" alt="profile picture" class="profile-picture">
                        <button id="change-picture" class="btn ctm-btn">Change</button>
                    </div>
                    <h3 id="username" class="ctm-text-light"></h3>
                    <h5 id="registration" class="ctm-text-light"></h5>
                    <h5 id="total-friends" class="ctm-text-light"></h5>
                    <h5 id="total-matches" class="ctm-text-light"></h5>
                    <div class="mt-2">
                        <button id="edit-profile" class="btn ctm-btn">Edit profile</button>
                        <button id="save-changes" class="btn ctm-btn" style="display: none;">Save changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="customize-section" class="container mt-5 blinking-neon-frame" style="display: none;">
        <div id="customize-photo" class="ctm-card position-relative">
            <h2 class="text-center ctm-text-title">Customize profile photo</h2>
            <div class="d-flex justify-content-center">
                <div class="d-flex flex-column align-items-center">
                    <div class="profile-picture-container mb-2">
                        <div id="carousel-container" class="carousel slide" data-bs-interval="false">
                            <div class="carousel-inner">
                                <div class="carousel-item active">
                                    <canvas id="avatarCanvas1" class="d-block profile-picture" alt="Avatar 1"></canvas>
                                </div>
                                <div class="carousel-item">
                                    <canvas id="avatarCanvas2" class="d-block profile-picture" alt="Avatar 2"></canvas>
                                </div>
                                <div class="carousel-item">
                                    <canvas id="avatarCanvas3" class="d-block profile-picture" alt="Avatar 3"></canvas>
                                </div>
                                <!-- <div class="carousel-item">
                                    <img id="uploadedImage" class="d-block profile-picture" alt="Uploaded Image">
                                </div> -->
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#carousel-container" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#carousel-container" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                            <div class="ctm-text-light text-center">slide to change style</div>
                        </div>
                        <div class="container d-flex justify-content-center m-3">
                            <button id="change-avatar-color" class="btn ctm-btn me-2">Change Avatar Color</button>
                            <input type="color" id="avatar-color-picker" style="display: none;">
                            <button id="change-background-color" class="btn ctm-btn">Change Background</button>
                            <input type="color" id="background-color-picker" style="display: none;">
                        </div>
                    </div>
                    <div class="d-flex m-2">
                        <div class="ctm-text-light">or upload your own image</div>
                        <button id="upload-image" class="btn ctm-btn ms-2">Upload</button>
                        <input type="file" id="file-input" accept="image/*" style="display: none;">
                    </div>
                    <div class="mt-2">
                        <button id="save-custom-photo" class="btn ctm-btn">Save changes</button>
                        <!-- <button id="cancel-custom-photo" class="btn ctm-btn ms-2">Cancel</button> -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const user = {
            username: 'erivero-',
            registration: '3/11/24',
            totalFriends: 3,
            totalMatches: 42,
            profilePicture: 'https://avatars.githubusercontent.com/u/131959167?v=4'
        };
        
        const elements = {
            username: document.getElementById('username'),
            registration: document.getElementById('registration'),
            totalFriends: document.getElementById('total-friends'),
            totalMatches: document.getElementById('total-matches'),
            editProfile: document.getElementById('edit-profile'),
            saveChanges: document.getElementById('save-changes'),
            profileCard: document.getElementById('profile-card'),
            profilePicture: document.getElementById('profile-picture'),
            fileInput: document.getElementById('file-input'),
            changePicture: document.getElementById('change-picture'),
            profileSection: document.getElementById('profile-section'),
            customizeSection: document.getElementById('customize-section'),
            uploadImage: document.getElementById('upload-image'),
            saveCustomPhoto: document.getElementById('save-custom-photo'),
            cancelCustomPhoto: document.getElementById('cancel-custom-photo'),
            avatarColorButton: document.getElementById('change-avatar-color'),
            avatarColorPicker: document.getElementById('avatar-color-picker'),
            backgroundColorButton: document.getElementById('change-background-color'),
            backgroundColorPicker: document.getElementById('background-color-picker'),
            uploadedImage: document.getElementById('uploadedImage')
        };
        
        const avatarImages = [
            './resources/avatar/avatar_1.png',
            './resources/avatar/avatar_2.png',
            './resources/avatar/avatar_3.png',
        ];
        
        function renderUserData() {
            elements.username.textContent = user.username;
            elements.registration.textContent = `Registered on: ${user.registration}`;
            elements.totalFriends.textContent = `Friends: ${user.totalFriends}`;
            elements.totalMatches.textContent = `Total matches: ${user.totalMatches}`;
            elements.profilePicture.src = user.profilePicture;
        }
        
        function toggleEditMode(isEditing) {
            elements.editProfile.style.display = isEditing ? 'none' : 'block';
            elements.saveChanges.style.display = isEditing ? 'block' : 'none';
            elements.changePicture.style.display = isEditing ? 'block' : 'none';
            
            if (isEditing) {
                elements.username.innerHTML = `
                    <div class="d-flex justify-content-center">New username:</div>
                    <input type="text" class="ctm-text-dark text-center" value="${user.username}">
                `;
                renderCancelBtn(elements.profileCard, () => toggleEditMode(false));
            } else {
                renderUserData();
                removeCancelBtn(elements.profileCard);
            }
        }
        
        function renderCancelBtn(container, onClick) {
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'x';
            cancelBtn.className = 'btn ctm-text-title position-absolute top-0 end-0 m-2';
            cancelBtn.id = 'cancel-edit';
            cancelBtn.addEventListener('click', onClick);
            container.appendChild(cancelBtn);
            console.log("rendering cancelBtn on container: ", container);
        }
        
        function removeCancelBtn(container) {
            const cancelBtn = document.getElementById('cancel-edit');
            console.log("removing or whatever");
            if (cancelBtn) cancelBtn.remove();
        }
        
        function showCustomizeSection() {
            elements.profileSection.style.display = 'none';
            elements.customizeSection.style.display = 'block';

            const customizePhoto = document.getElementById('customize-photo');
        
            renderCancelBtn(customizePhoto, () => {
                elements.profileSection.style.display = 'block';
                elements.customizeSection.style.display = 'none';
                // removeCancelBtn(customizePhoto);
            });
        }
        
        if (elements.changePicture) {
            elements.changePicture.addEventListener('click', showCustomizeSection);
        }
        
        if (elements.saveCustomPhoto) {
            elements.saveCustomPhoto.addEventListener('click', () => {
                const selectedCanvas = document.querySelector('.carousel-item.active canvas, .carousel-item.active img');
                if (selectedCanvas.tagName === 'CANVAS') {
                    user.profilePicture = selectedCanvas.toDataURL();
                } else {
                    user.profilePicture = selectedCanvas.src;
                }
                elements.profilePicture.src = user.profilePicture;
                elements.profileSection.style.display = 'block';
                elements.customizeSection.style.display = 'none';
                removeCancelBtn(elements.customizeSection);
            });
        }
        
        if (elements.cancelCustomPhoto) {
            elements.cancelCustomPhoto.addEventListener('click', () => {
                elements.profileSection.style.display = 'block';
                elements.customizeSection.style.display = 'none';
                removeCancelBtn(elements.customizeSection);
            });
        }
        
        if (elements.avatarColorButton) {
            elements.avatarColorButton.addEventListener('click', () => {
                elements.avatarColorPicker.click();
            });
        }
        
        if (elements.avatarColorPicker) {
            elements.avatarColorPicker.addEventListener('change', (event) => {
                const selectedColor = event.target.value;
                document.querySelectorAll('.carousel-item canvas').forEach(canvas => {
                    changeAvatarColor(canvas, selectedColor);
                });
            });
        }
        
        if (elements.backgroundColorButton) {
            elements.backgroundColorButton.addEventListener('click', () => {
                elements.backgroundColorPicker.click();
            });
        }
        
        if (elements.backgroundColorPicker) {
            elements.backgroundColorPicker.addEventListener('change', (event) => {
                const selectedColor = event.target.value;
                document.querySelectorAll('.profile-picture').forEach(img => {
                    img.style.backgroundColor = selectedColor;
                });
            });
        }
        
        if (elements.editProfile) {
            elements.editProfile.addEventListener('click', () => toggleEditMode(true));
        }
        
        if (elements.saveChanges) {
            elements.saveChanges.addEventListener('click', () => {
                user.username = elements.username.querySelector('input').value;
                toggleEditMode(false);
            });
        }
        
        if (elements.uploadImage) {
            elements.uploadImage.addEventListener('click', () => {
                elements.fileInput.click();
            });
        }
        
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    let uploadedImageItem = document.getElementById('uploaded-image-item');
                    if (!uploadedImageItem) {
                        const carouselInner = document.querySelector('.carousel-inner');
                        const newCarouselItem = document.createElement('div');
                        newCarouselItem.className = 'carousel-item';
                        newCarouselItem.id = 'uploaded-image-item';
                        uploadedImage = document.createElement('img');
                        uploadedImage.id = 'uploadedImage';
                        uploadedImage.className = 'd-block profile-picture';
                        uploadedImage.alt = 'Uploaded Image';
                        newCarouselItem.appendChild(uploadedImage);
                        carouselInner.appendChild(newCarouselItem);
                        
                    }
                    scrollToNewPhoto();
                    uploadedImage.src = e.target.result;
                    // const carousel = new bootstrap.Carousel(document.querySelector('#carousel-container'));
                    // carousel.to(Array.from(carouselInner.children).indexOf(uploadedImage.parentElement));
                };
                reader.readAsDataURL(file);
            }
        }

        function scrollToNewPhoto() {
            const activeItem = document.querySelector('.carousel-item.active');
            const item = document.getElementById('uploaded-image-item');
            if (activeItem && item !== activeItem) {
                activeItem.classList.remove('active');
                item.classList.add('active');
            }
        }
        
        if (elements.fileInput) {
            elements.fileInput.addEventListener('change', handlePhotoUpload);
        }
        
        function loadImageToCanvas(canvas, src) {
            return new Promise((resolve) => {
                const context = canvas.getContext('2d');
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.src = src;
                img.onload = function() {
                    canvas.width = 500;
                    canvas.height = 500;
                    context.clearRect(0, 0, canvas.width, canvas.height);
                    context.drawImage(img, 0, 0, 500, 500);
                    resolve();
                };
            });
        }
        
        function changeAvatarColor(canvas, color) {
            const context = canvas.getContext('2d');
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
        
            for (let i = 0; i < data.length; i += 4) {
                // Check if the pixel is not transparent
                if (data[i + 3] !== 0) {
                    data[i] = parseInt(color.slice(1, 3), 16);     // Red
                    data[i + 1] = parseInt(color.slice(3, 5), 16); // Green
                    data[i + 2] = parseInt(color.slice(5, 7), 16); // Blue
                }
            }
        
            context.putImageData(imageData, 0, 0);
        }
        
        window.onload = function() {
            const canvases = [
                document.getElementById('avatarCanvas1'),
                document.getElementById('avatarCanvas2'),
                document.getElementById('avatarCanvas3')
            ];
        
            Promise.all(canvases.map((canvas, index) => loadImageToCanvas(canvas, avatarImages[index])))
                .then(() => {
                    console.log('All avatars loaded');
                });
        
            renderUserData();
        };
    </script>
    <script src="neon.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
</body>
</html>