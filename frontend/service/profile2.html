<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>patata</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">    
    <link rel="stylesheet" href="styles/styles.css">
    <style>
main {
    flex: 1;
}

.profile-picture-container {
    position: relative;
    display: inline-block;
    max-width: 300px;
    margin: 0 auto;
}

#change-picture {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: block;
    background-color: rgba(0, 0, 0, 0.5);
    height: 300px;
    width: 300px;
    border-radius: 50%;
    color: white;
    border: none;
    padding: 5px 10px;
    display: none;
}


canvas.profile-picture {
    background-color: transparent;
}

#carousel-container {
    max-width: 300px;
    margin: 0 auto;
}

.carousel-control-prev,
.carousel-control-next {
    background-color: rgba(0, 0, 0, 0.5);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    top: 50%;
    transform: translateY(-50%);
}

.carousel-control-prev {
    left: -50px;
}

.carousel-control-next {
    right: -50px;
}

.profile-picture,
.carousel-item img,
.carousel-item canvas {
    width: 300px;
    height: 300px;
    object-fit: cover;
    border-radius: 50%;
}


</style>
</head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-dark ctm-navbar p-1">
            <span class="navbar-brand ms-2">PONG</span>
            <div class="d-flex ms-auto align-items-center">
                <a class="nav-link ctm-link" href="index.html">Home</a>
            </div>
        </nav>
        <main class="container py-4"> <!-- pendiente comprobar verticalwrapp -->
            <section id="profile-section" class="blinking-neon-frame">
                <div class="card ctm-card ctm-text-light">
                    <div class="card-body">
                        <h2 class="card-title text-center mb-4 ctm-text-title">My profile</h2>
                        <div class="row justify-content-center">
                            <div class="col-md-6 text-center">
                                <div class="profile-picture-container mb-3">
                                    <img id="profile-picture" src="https://avatars.githubusercontent.com/u/131959167?v=4" alt="profile picture" class="img-fluid rounded-circle">
                                    <button id="change-picture" class="btn">Change</button>
                                </div>
                                <h3 id="username" class="mb-2"></h3>
                                <p id="registration" class="mb-1"></p>
                                <p id="total-friends" class="mb-1"></p>
                                <p id="total-matches" class="mb-3"></p>
                                <div class="d-flex justify-content-center">
                                    <button id="edit-profile" class="btn ctm-btn">Edit profile</button>
                                    <button id="save-changes" class="btn ctm-btn" style="display: none;">Save changes</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section id="customize-section" class="blinking-neon-frame" style="display: none;">
                <div class="card ctm-card ctm-text-light">
                    <div class="card-body">
                        <h2 class="card-title text-center mb-4 ctm-text-title">Customize profile photo</h2>
                        <div class="row justify-content-center">
                            <div class="col-md-8">
                                <div id="carousel-container" class="carousel slide mb-4" data-bs-ride="carousel" data-bs-interval="false">
                                    <div class="carousel-inner">
                                        <div class="carousel-item active">
                                            <canvas id="avatarCanvas1" class="d-block w-100 rounded-circle" alt="Avatar 1"></canvas>
                                        </div>
                                        <div class="carousel-item">
                                            <canvas id="avatarCanvas2" class="d-block w-100 rounded-circle" alt="Avatar 2"></canvas>
                                        </div>
                                        <div class="carousel-item">
                                            <canvas id="avatarCanvas3" class="d-block w-100 rounded-circle" alt="Avatar 3"></canvas>
                                        </div>
                                    </div>
                                    <button class="carousel-control-prev" type="button" data-bs-target="#carousel-container" data-bs-slide="prev">
                                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                        <span class="visually-hidden">Previous</span>
                                    </button>
                                    <button class="carousel-control-next" type="button" data-bs-target="#carousel-container" data-bs-slide="next">
                                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                        <span class="visually-hidden">Next</span>
                                    </button>
                                </div>
                                <div class="text-center mb-3">
                                    <button id="change-avatar-color" class="btn ctm-btn me-2">Change Avatar Color</button>
                                    <input type="color" id="avatar-color-picker" style="display: none;">
                                    <button id="change-background-color" class="btn ctm-btn">Change Background</button>
                                    <input type="color" id="background-color-picker" style="display: none;">
                                </div>
                                <div class="text-center mb-3">
                                    <p class="mb-2">or upload your own image</p>
                                    <button id="upload-image" class="btn ctm-btn-secondary">Upload</button>
                                    <input type="file" id="file-input" accept="image/*" style="display: none;">
                                </div>
                                <div class="text-center">
                                    <button id="save-custom-photo" class="btn ctm-btn">Save changes</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>  
    </main>
    <script src="app/neon.js"></script>
    <!-- <script src="app/render.js"></script> -->
<!--     <script src="app/profile.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script>

const user = {
    username: 'erivero-',
    registration: '3/11/24',
    totalFriends: 3,
    totalMatches: 42,
    profilePicture: 'https://avatars.githubusercontent.com/u/131959167?v=4'
};

const elements = {
    username: document.getElementById('username'),
    registration: document.getElementById('registration'),
    totalFriends: document.getElementById('total-friends'),
    totalMatches: document.getElementById('total-matches'),
    editProfile: document.getElementById('edit-profile'),
    saveChanges: document.getElementById('save-changes'),
    profileCard: document.querySelector('#profile-section .card'),
    profilePicture: document.getElementById('profile-picture'),
    fileInput: document.getElementById('file-input'),
    changePicture: document.getElementById('change-picture'),
    profileSection: document.getElementById('profile-section'),
    customizeSection: document.getElementById('customize-section'),
    uploadImage: document.getElementById('upload-image'),
    saveCustomPhoto: document.getElementById('save-custom-photo'),
    avatarColorButton: document.getElementById('change-avatar-color'),
    avatarColorPicker: document.getElementById('avatar-color-picker'),
    backgroundColorButton: document.getElementById('change-background-color'),
    backgroundColorPicker: document.getElementById('background-color-picker'),
};

const avatarImages = [
    './resources/avatar/avatar_1.png',
    './resources/avatar/avatar_2.png',
    './resources/avatar/avatar_3.png',
];

function renderUserData() {
    elements.username.textContent = user.username;
    elements.registration.textContent = `Registered on: ${user.registration}`;
    elements.totalFriends.textContent = `Friends: ${user.totalFriends}`;
    elements.totalMatches.textContent = `Total matches: ${user.totalMatches}`;
    elements.profilePicture.src = user.profilePicture;
}

function toggleEditMode(isEditing) {
    elements.editProfile.style.display = isEditing ? 'none' : 'inline-block';
    elements.saveChanges.style.display = isEditing ? 'inline-block' : 'none';
    elements.changePicture.style.display = isEditing ? 'inline-block' : 'none';
    
    if (isEditing) {
        elements.username.innerHTML = `
            <div class="mb-2">New username:</div>
            <input type="text" class="form-control mb-2" value="${user.username}">
        `;
        renderCancelBtn(elements.profileCard, () => toggleEditMode(false));
    } else {
        renderUserData();
        removeCancelBtn(elements.profileCard);
    }
}

function renderCancelBtn(container, onClick) {
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'Cancel';
    cancelBtn.className = 'btn btn-danger position-absolute top-0 end-0 m-2';
    cancelBtn.id = 'cancel-edit';
    cancelBtn.addEventListener('click', onClick);
    container.appendChild(cancelBtn);
}

function removeCancelBtn(container) {
    const cancelBtn = document.getElementById('cancel-edit');
    if (cancelBtn) cancelBtn.remove();
}

function showCustomizeSection() {
    elements.profileSection.style.display = 'none';
    elements.customizeSection.style.display = 'block';

    const customizePhoto = document.querySelector('#customize-section .card');

    renderCancelBtn(customizePhoto, () => {
        elements.profileSection.style.display = 'block';
        elements.customizeSection.style.display = 'none';
        removeCancelBtn(customizePhoto);
    });
}

if (elements.changePicture) {
    elements.changePicture.addEventListener('click', showCustomizeSection);
}

if (elements.saveCustomPhoto) {
    elements.saveCustomPhoto.addEventListener('click', () => {
        const selectedCanvas = document.querySelector('.carousel-item.active canvas');
        if (selectedCanvas) {
            // Create a temporary canvas to maintain aspect ratio
            const tempCanvas = document.createElement('canvas');
            const ctx = tempCanvas.getContext('2d');
            const size = Math.min(selectedCanvas.width, selectedCanvas.height);
            tempCanvas.width = tempCanvas.height = size;
            ctx.drawImage(selectedCanvas, 
                (selectedCanvas.width - size) / 2, 
                (selectedCanvas.height - size) / 2, 
                size, size, 
                0, 0, size, size
            );
            user.profilePicture = tempCanvas.toDataURL();
        } else {
            const selectedImage = document.querySelector('.carousel-item.active img');
            if (selectedImage) {
                user.profilePicture = selectedImage.src;
            }
        }
        elements.profilePicture.src = user.profilePicture;
        elements.profilePicture.style.objectFit = 'cover';
        elements.profileSection.style.display = 'block';
        elements.customizeSection.style.display = 'none';
        removeCancelBtn(elements.customizeSection);
    });
}

if (elements.avatarColorButton) {
    elements.avatarColorButton.addEventListener('click', () => {
        elements.avatarColorPicker.click();
    });
}

if (elements.avatarColorPicker) {
    elements.avatarColorPicker.addEventListener('change', (event) => {
        const selectedColor = event.target.value;
        document.querySelectorAll('.carousel-item canvas').forEach(canvas => {
            changeAvatarColor(canvas, selectedColor);
        });
    });
}

if (elements.backgroundColorButton) {
    elements.backgroundColorButton.addEventListener('click', () => {
        elements.backgroundColorPicker.click();
    });
}

if (elements.backgroundColorPicker) {
    elements.backgroundColorPicker.addEventListener('change', (event) => {
        const selectedColor = event.target.value;
        document.querySelectorAll('.carousel-item canvas, .carousel-item img').forEach(img => {
            img.style.backgroundColor = selectedColor;
        });
    });
}

if (elements.editProfile) {
    elements.editProfile.addEventListener('click', () => toggleEditMode(true));
}

if (elements.saveChanges) {
    elements.saveChanges.addEventListener('click', () => {
        user.username = elements.username.querySelector('input').value;
        toggleEditMode(false);
    });
}

if (elements.uploadImage) {
    elements.uploadImage.addEventListener('click', () => {
        elements.fileInput.click();
    });
}

function handlePhotoUpload(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            let uploadedImageItem = document.getElementById('uploaded-image-item');
            if (!uploadedImageItem) {
                const carouselInner = document.querySelector('.carousel-inner');
                const newCarouselItem = document.createElement('div');
                newCarouselItem.className = 'carousel-item';
                newCarouselItem.id = 'uploaded-image-item';
                const uploadedCanvas = document.createElement('canvas');
                uploadedCanvas.id = 'uploadedImage';
                uploadedCanvas.className = 'd-block w-100 rounded-circle';
                uploadedCanvas.width = uploadedCanvas.height = 300;
                newCarouselItem.appendChild(uploadedCanvas);
                carouselInner.appendChild(newCarouselItem);
            }
            const uploadedCanvas = document.getElementById('uploadedImage');
            const ctx = uploadedCanvas.getContext('2d');
            const img = new Image();
            img.onload = function() {
                const size = Math.min(img.width, img.height);
                ctx.drawImage(img, 
                    (img.width - size) / 2, 
                    (img.height - size) / 2, 
                    size, size, 
                    0, 0, 300, 300
                );
                scrollToNewPhoto();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}


function scrollToNewPhoto() {
    const activeItem = document.querySelector('.carousel-item.active');
    const item = document.getElementById('uploaded-image-item');
    if (activeItem && item !== activeItem) {
        activeItem.classList.remove('active');
        item.classList.add('active');
    }
}

if (elements.fileInput) {
    elements.fileInput.addEventListener('change', handlePhotoUpload);
}

function loadImageToCanvas(canvas, src) {
    return new Promise((resolve) => {
        const context = canvas.getContext('2d');
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.src = src;
        img.onload = function() {
            canvas.width = 300;
            canvas.height = 300;
            context.clearRect(0, 0, canvas.width, canvas.height);
            const size = Math.min(img.width, img.height);
            context.drawImage(img, 
                (img.width - size) / 2, 
                (img.height - size) / 2, 
                size, size, 
                0, 0, 300, 300
            );
            resolve();
        };
    });
}

function changeAvatarColor(canvas, color) {
    const context = canvas.getContext('2d');
    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;

    for (let i = 0; i < data.length; i += 4) {
        // Check if the pixel is not transparent
        if (data[i + 3] !== 0) {
            data[i] = parseInt(color.slice(1, 3), 16);     // Red
            data[i + 1] = parseInt(color.slice(3, 5), 16); // Green
            data[i + 2] = parseInt(color.slice(5, 7), 16); // Blue
        }
    }

    context.putImageData(imageData, 0, 0);
}

window.onload = function() {
    const canvases = [
        document.getElementById('avatarCanvas1'),
        document.getElementById('avatarCanvas2'),
        document.getElementById('avatarCanvas3')
    ];

    Promise.all(canvases.map((canvas, index) => loadImageToCanvas(canvas, avatarImages[index])))
        .then(() => {
            console.log('All avatars loaded');
        });

    renderUserData();
};


    </script>
</body>
</html>