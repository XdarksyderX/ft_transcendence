<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">    
  <link rel="stylesheet" href="../../styles.css">
  <title>Tournament Bracket</title>
  <style>
 body {
		font-family: 'VT323', monospace;
		margin: 20px;
      	padding: 0;
        overflow-y: auto;

    }

    .bracket {
      display: flex;
      flex-direction: row;
      justify-content: space-around;
      align-items: stretch; /* Ensure all rounds stretch to the same height */
    }

    .round {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0 20px;
      flex: 1; /* Ensure each round takes equal space */
	  position: relative;
	  justify-content: center;
    }

	.round.even {
		/* background: linear-gradient(to top, var(--medium), var(--dark)); */
		/* background-color: #2d124074; */
		border-left: 1px solid var(--light);
		border-right: 1px solid var(--light);
		border-radius: 5px;
	}

    .match {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-around;
      width: 120px;
      height: 60px;
      border: 2px solid var(--light);
	    box-shadow: 0 0 5px var(--light);

      margin: 10px 0;
      border-radius: 5px;
      /* background-color: #fff; */
      cursor: pointer;
    }

	  .match.pending {
      border-color: var(--lorange);
      box-shadow: 0 0 5px var(--lorange);

    }

    .match.available {
    border-color: var(--lorange);
    box-shadow: 0 0 5px var(--lorange);
    animation: blink 1s infinite;
    }
    .match.done {
      border-color: var(--accent);
      box-shadow: 0 0 5px var(--accent);
    }
  @keyframes blink {
  0%, 100% {
    box-shadow: 0 0 10px var(--lorange);
  }
  50% {
    box-shadow: 0 0 5px transparent;
  }
}


    .winner {
		color: var(--accent);
		text-shadow: 0 0 2px var(--light);
    }

    .round-title {
      font-weight: bold;
      margin-bottom: 10px;
	  position: relative;
    }
	
	.match-divider {
    border-top: 1px solid var(--light);
	width: 75%;
	}
  .ctm-card {
    box-shadow: 0 0 10px #00F56A, 0 0 20px #00F56A, 0 0 30px #00F56A, 0 0 40px #00F56Acc;
  }
  </style>
</head>
<body>
  <h1 class="ctm-text-title text-center mb-5">Ongoing Tournaments</h1>
  <div id="tournaments-container"></div>
  <!-- modal -->
  <div class="modal fade" id="start-match-modal" tabindex="-1" aria-labelledby="startMatchLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title ctm-text-title" id="waitGameLabel">Start game</h5>
          <button type="button" class="close-modal" data-bs-dismiss="modal" aria-label="Close">x</button>
        </div>
        <div class="modal-body">
          <p id="modal-text">Do you want to start your tournament match now?</p>
        <div class="modal-footer">
          <button type="button" class="btn ctm-btn" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn ctm-btn" data-bs-dismiss="modal" onclick="navigateTo('/start-game')">Exit</button>
      </div>
  </div>
</div>
</div> -
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  <script>

 
const tournament1 = {
  tournamentName: "Copa champiñón",
  phases: [
    {
      number: 1,
      status: "closed",
      matches: [
        {
          matchId: 1,
          teams: ["Team A", "Team B"],
          status: "completed",
          winner: "Team A"
        },
        {
          matchId: 2,
          teams: ["Team C", "Team D"],
          status: "completed",
          winner: "Team C"
        },
        {
          matchId: 3,
          teams: ["Team E", "Team F"],
          status: "completed",
          winner: "Team F"
        },
        {
          matchId: 4,
          teams: ["Team G", "Team H"],
          status: "completed",
          winner: "Team G"
        }
      ]
    },
    {
      number: 2,
      status: "closed",
      matches: [
        {
          matchId: 5,
          teams: ["Team C", "Team G"],
          status: "completed",
          winner: "Team G"
        },
        {
          matchId: 6,
          teams: ["Team A", "Team F"],
          status: "completed",
          winner: "Team A"
        }
      ]
    },
    {
      number: 3,
      status: "closed",
      matches: [
        {
          matchId: 7,
          teams: ["Team G", "Team A"],
          status: "completed",
          winner: "Team A"
        }
      ]
    }
  ]
};

const tournament2 = {
  tournamentName: "Copa cebollino",
  phases: [
    {
      number: 1,
      status: "open",
      matches: [
        {
          matchId: 1,
          teams: ["Team A", "Team B"],
          status: "pending",
          winner: null
        },
        {
          matchId: 2,
          teams: ["Team C", "Team D"],
          status: "completed",
          winner: "Team C"
        },
        {
          matchId: 3,
          teams: ["Team E", "Team F"],
          status: "pending",
          winner: null
        },
        {
          matchId: 4,
          teams: ["Team G", "Team H"],
          status: "completed",
          winner: "Team G"
        }
      ]
    },
    {
      number: 2,
      status: "closed",
      matches: [
        {
          matchId: 5,
          teams: ["Team C", "Team G"],
          status: "pending",
          winner: null
        },
        {
          matchId: 6,
          teams: ["???", "???"],
          status: "pending",
          winner: null
        }
      ]
    },
    {
      number: 3,
      status: "closed",
      matches: [
        {
          matchId: 7,
          teams: ["???", "???"],
          status: "pending",
          winner: null
        }
      ]
    }
  ]
};

const tournaments = [tournament1, tournament2];

function renderAllTournaments() {
  console.log('Rendering all tournaments');
  const container = document.getElementById('tournaments-container');
  container.innerHTML = '';

  tournaments.forEach(oneTournament => {
    const tournament = generateTournament(oneTournament);
    container.appendChild(tournament);
  });

  container.addEventListener('click', (e) => {
    const matchElement = e.target.closest('.match.available'); // looks for the closest available match to the click
    if (matchElement) {
      const matchId = matchElement.dataset.matchId; //access to the data-match-id we added while creating the element
      const allMatches = tournaments.flatMap(tournament => tournament.phases.flatMap(phase => phase.matches)); // combines all matches in one array
      const match = allMatches.find(m => m.matchId.toString() === matchId); // looks for the clicked match on the array to check if it exists
      if (match) {
        console.log('Match clicked:', match);
        triggerModal(match);
      }
    }
  });
}

function generateTournament(tournament) {
  console.log('Generating tournament:', tournament.tournamentName);
  const container = document.createElement('div');
  container.classList.add("ctm-card");
  container.classList.add("mt-5");
  const bracket = generateBracket(tournament);
  container.innerHTML = `
    <div class="text-center ctm-text-title mb-3">${tournament.tournamentName}</div>
    ${bracket.outerHTML}
  `;
  return container;
}

function generateBracket(tournament) {
  console.log('Generating bracket for tournament:', tournament.tournamentName);
  const bracket = document.createElement('div');
  bracket.classList.add('bracket', 'ctm-text-light');
  tournament.phases.forEach(phase => {
    const round = generateRound(phase);
    bracket.appendChild(round);
  });
  return bracket;
}

function generateRound(phase) {
  console.log('Generating round:', phase.number);
  const round = document.createElement('div');
  round.classList.add('round');
  if (phase.number % 2 === 0) {
    round.classList.add('even');
  }
  const matches = generateMatches(phase.matches, phase.status === 'open');
  round.innerHTML = `
    <div class="mt-2 ${phase.number === 1 ? '' : 'position-absolute top-0'}">Phase ${phase.number}</div>
  `;
  matches.forEach(matchElement => round.appendChild(matchElement));
  return round;
}

function generateMatches(matches, openPhase) {
  console.log('Generating matches for phase, open:', openPhase);
  return matches.map(match => generateMatch(match, openPhase));
}

function generateMatch(match, openPhase) {
  console.log('Generating match:', match.matchId);
  const matchElement = document.createElement('div');
  matchElement.id = match.matchId;
  matchElement.classList.add('match');
  
  if (match.status === 'pending' && openPhase && match.teams.length === 2) {
    console.log('Match is pending, phase is open, and teams are complete:', match);
    if (match.teams.includes('Team A')) {
      matchElement.classList.add('available');
    }
    else
       matchElement.classList.add('pending');
    matchElement.dataset.matchId = match.matchId;
  }
  if (match.winner) {
    matchElement.classList.add('done');
  }
  
  matchElement.innerHTML = `
    <div class="${match.winner === match.teams[0] ? 'winner' : ''}">${match.teams[0]}</div>
    <div class="match-divider"></div>
    <div class="${match.winner === match.teams[1] ? 'winner' : ''}">${match.teams[1]}</div>
  `;
  
  return matchElement;
}

function triggerModal(match) {
  console.log('Triggering modal for match:', match);
  const modal = new bootstrap.Modal(document.getElementById('start-match-modal'));
  modal.show();
}

document.addEventListener('DOMContentLoaded', () => {
  console.log('DOMContentLoaded event fired');
  renderAllTournaments();
});

  </script>
</body>
</html>
